#+TITLE: blazingly-fast emacs configuration
#+AUTHOR: Shakhzod Kudratov
#+EMAIL: shakhzodkudratov@gmail.com
#+OPTIONS: num:nil

* General configurations
#+BEGIN_SRC emacs-lisp
  (setq user-full-name "Shakhzod Kudratov")
  (setq user-mail-address "shakhzodkudratov@gmail.com")

  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (column-number-mode 1)

  (setq inhibit-startup-screen t)
  (setq initial-scratch-message nil)
  (setq confirm-kill-emacs #'yes-or-no-p)

  (setq scroll-margin 8)
  (setq scroll-conservatively 101)
  (setq scroll-preserve-screen-position t)
  (setq auto-window-vscroll nil)
  (setq custom-file "~/.emacs.custom")
  (load custom-file 'noerror)

  (load-theme 'gruvbox-dark-medium t)

  (add-to-list 'load-path (file-name-directory load-file-name))

  (defun open-init-file ()
    "Open the Emacs initialization file for editing."
    (interactive)
    (find-file *config-file*))

  '(default-frame-alist
    '((fullscreen . fullscreen)
      (font . "JetBrainsMono Nerd Font-13")
      (line-spacing . 0.2)))

  ;; For line spacing adjustments (optional, recommended 1.2 by JetBrains)
  (setq line-spacing 0.2) ;; 0.2 adds extra space below each line

  ;; For the best syntax highlighting experience with the widest selection of font-lock faces, set the font-lock level to 4 (maximum):
  (setq treesit-font-lock-level 4)
#+END_SRC

** Darwin related configurations
#+BEGIN_SRC emacs-lisp
  (defconst *is-a-mac* (eq system-type 'darwin))
  (when *is-a-mac*

  (add-to-list 'default-frame-alist '(fullscreen . fullscreen))
  ;; (add-to-list 'default-frame-alist '(fullscreen . maximized))
  ;; (add-to-list 'default-frame-alist '(fullscreen . fullboth))

  ; macOS fullscreen option (emacs-macport uses mac- prefix)
  (setq mac-use-native-fullscreen t))
#+END_SRC

* Meow
** Meow Gallium Layout
#+BEGIN_SRC emacs-lisp
  (defconst meow-cheatsheet-layout-gallium
    '((<TLDE> "`"	"~")
      (<AE01> "1"	"!")
      (<AE02> "2"	"@")
      (<AE03> "3"	"#")
      (<AE04> "4"	"$")
      (<AE05> "5"	"%")
      (<AE06> "6"	"^")
      (<AE07> "7"	"&")
      (<AE08> "8"	"*")
      (<AE09> "9"	"(")
      (<AE10> "0"	")")
      (<AE11> "-"	"_")
      (<AE12> "="	"+")
      (<AD01> "b"	"B")
      (<AD02> "l"	"L")
      (<AD03> "d"	"D")
      (<AD04> "c"	"C")
      (<AD05> "v"	"V")
      (<AD06> "z"	"Z")
      (<AD07> "y"	"Y")
      (<AD08> "o"	"O")
      (<AD09> "u"	"U")
      (<AD10> ","	"<")
      (<AD11> "/"	"?")
      (<AD12> "]"	"}")
      (<AC01> "n"	"N")
      (<AC02> "r"	"R")
      (<AC03> "t"	"T")
      (<AC04> "s"	"S")
      (<AC05> "g"	"G")
      (<AC06> "p"	"P")
      (<AC07> "h"	"H")
      (<AC08> "a"	"A")
      (<AC09> "e"	"E")
      (<AC10> "i"	"I")
      (<AC11> "-"	"_")
      (<AB01> "q"	"Q")
      (<AB02> "x"	"X")
      (<AB03> "m"	"M")
      (<AB04> "w"	"W")
      (<AB05> "j"	"J")
      (<AB06> "k"	"K")
      (<AB07> "f"	"F")
      (<AB08> "'"	"\"")
      (<AB09> ";"	":")
      (<AB10> "."	">")
      (<BKSL> "\\" "|")))
#+END_SRC

** Core
inspired from: https://github.com/eshrh/nyaatouch/

#+BEGIN_SRC emacs-lisp
  (require 'meow)
  (require 'smartparens)
  (require 'avy)
  (require 'meow-tree-sitter)
  (require 'swiper)
  (require 'cl-lib)

  (meow-tree-sitter-register-defaults)

  (define-key key-translation-map [?\C-x] [?\C-u])
  (define-key key-translation-map [?\C-u] [?\C-x])

  (defmacro nt--call-negative (form)
  `(let ((current-prefix-arg -1))
  (call-interactively ,form)))

  (defun nt-negative-find ()
  (interactive)
  (nt--call-negative 'meow-find))

  (defun nt-negative-till ()
  (interactive)
  (nt--call-negative 'meow-till))

  (put 'upcase-region 'disabled nil)

  (defun uppercasep (c) (and (= ?w (char-syntax c)) (= c (upcase c))))

  (defun downcase-char ()
  (interactive)
  (save-excursion
  (let ((ch (thing-at-point 'char t)))
  (delete-char 1)
  (insert (downcase ch)))))

  (defun nt-toggle-case-dwiam ()
  "toggle cases, do what i actually mean:

  If no region is active, toggle between upcase and downcase on the
  current character. If a region is active, then if there exists at
  least one upcase char in the region, then downcase the whole
  region. Otherwise, upcase the whole region."
  (interactive)
  (if (region-active-p)
  (let ((region (buffer-substring-no-properties
  (region-beginning) (region-end))))
  (message "%s" region)
  (if (cl-remove-if-not #'uppercasep (string-to-list region))
  (downcase-region (region-beginning) (region-end))
  (upcase-region (region-beginning) (region-end))))
  (if (uppercasep (string-to-char (thing-at-point 'char t)))
  (downcase-char)
  (upcase-char 1))))

  (defun replace-bounds (strt end content)
  (delete-region strt end)
  (insert (number-to-string content)))

  (defun nt-add-number (arg)
  (interactive "P")
  (let* ((num (thing-at-point 'number t))
  (bounds (bounds-of-thing-at-point 'word))
           (strt (car bounds))
           (end (cdr bounds)))
      (message "%s" arg)
      (if arg
          (replace-bounds strt end (+ num arg))
        (replace-bounds strt end (+ num 1)))))

  (defun nt-subtract-one ()
    (interactive)
    (let ((current-prefix-arg -1))
      (call-interactively #'nt-add-number)))

  (defun nt-goto-top ()
    (interactive)
    (let ((res (sp-up-sexp)))
      (while res
        (setq res (sp-up-sexp)))))

  (defun nt-insert-at-cursor ()
    (interactive)
    (if meow--temp-normal
        (progn
          (message "Quit temporary normal mode")
          (meow--switch-state 'motion))
      (meow--cancel-selection)
      (meow--switch-state 'insert)))


  (defun nt-duplicate ()
    "Duplicate region if active. Otherwise duplicate char at point"
    (interactive)
    (if (region-active-p)
        (progn
          (meow-save)
          (meow-yank))
      (progn
        (meow-save-char)
        (meow-yank))))

  (defun nt-duplicate-and-comment ()
    "Duplicate region and then comment region"
    (interactive)
    (if (region-active-p)
        (progn
          (meow-save)
          (comment-or-uncomment-region
           (region-beginning)
           (region-end))
          (meow-yank))))



  (setq meow-cheatsheet-layout meow-cheatsheet-layout-gallium)

  ;; expansion
  (meow-normal-define-key
   '("0" . meow-expand-0)
   '("9" . meow-expand-9)
   '("8" . meow-expand-8)
   '("7" . meow-expand-7)
   '("6" . meow-expand-6)
   '("5" . meow-expand-5)
   '("4" . meow-expand-4)
   '("3" . meow-expand-3)
   '("2" . meow-expand-2)
   '("1" . meow-expand-1)
   '(";" . meow-reverse))

  ;; movement
  (meow-normal-define-key
   '("f" . meow-find)
   '("F" . nt-negative-find)
   '("t" . meow-till)
   '("T" . nt-negative-till)
   '("<" . beginning-of-buffer)
   '(">" . end-of-buffer)
   '("b" . meow-back-word)
   '("B" . meow-back-symbol)
   '("e" . meow-next-word)
   '("E" . meow-next-symbol)
   '("g" . meow-goto-line)
   '("G" . meow-grab))

  (defun nt-inner-str () (interactive) (meow-inner-of-thing ?g))
  (defun nt-bounds-str () (interactive) (meow-bounds-of-thing ?g))
  (defun nt-paragraph () (interactive) (meow-inner-of-thing ?p))

  ;; selection
  (meow-normal-define-key
   '("," . meow-inner-of-thing)
   '("." . meow-bounds-of-thing)
   '("l" . meow-line)
   '("o" . nt-inner-str)
   '("O" . nt-bounds-str)
   '("w" . meow-mark-word)
   '("W" . meow-mark-symbol)
   '("p" . meow-block)
   '("P" . meow-block-expand)
   '("j" . meow-join))

  ;; insertion actions
  (meow-normal-define-key
   '("i" . nt-insert-at-cursor)
   '("I" . meow-open-above)
   '("a" . meow-append)
   '("A" . meow-open-below))

  ;; selection actions
  (meow-normal-define-key
   '("c" . meow-change)
   '("C" . meow-replace)
   '("s" . meow-save)
   '("k" . meow-kill)
   '("y" . meow-yank)
   '("u" . meow-undo)
   '("U" . meow-undo-in-selection)
   '("r" . meow-delete))

  ;; other actions
  (meow-normal-define-key
   '("h" . meow-cancel-selection)
   '("q" . meow-quit)
   '("'" . meow-paren-mode)
   '("z" . meow-pop-selection)
   '("d" . xref-find-definitions)
   '("D" . xref-go-back)
   '("n" . meow-search)
   '("m" . avy-goto-word-1)
   '("v" . repeat)
   '("<escape>" . ignore))

  ;; extras
  (meow-normal-define-key
   '("*" . nt-toggle-case-dwiam)
   '("+" . nt-add-number)
   '("_" . nt-subtract-one)
   '("/" . nt-duplicate)
   '("?" . nt-duplicate-and-comment)
   '("-" . swiper))

  (define-key meow-beacon-state-keymap [remap nt-insert-at-cursor] 'meow-beacon-insert)


  (setq meow-paren-keymap (make-keymap))

  (meow-define-state paren
    "paren state"
    :lighter " [P]"
    :keymap meow-paren-keymap)

  (setq meow-cursor-type-paren 'hollow)

  (defun nt-wrap-string () (interactive) (sp-wrap-with-pair "\""))
  (defun nt-back-transpose () (interactive) (sp-transpose-sexp -1))

  (meow-define-keys 'paren
    '("<escape>" . meow-normal-mode)
    '("f" . sp-backward-sexp)
    '("r" . sp-forward-sexp)
    '("h" . sp-down-sexp)
    '("t" . sp-up-sexp)
    '("o s" . sp-wrap-square)
    '("o r" . sp-wrap-round)
    '("o c" . sp-wrap-curly)
    '("o g" . nt-wrap-string)
    '("O" . sp-unwrap-sexp)
    '("b" . sp-slurp-hybrid-sexp)
    '("x" . sp-forward-barf-sexp)
    '("k" . sp-backward-barf-sexp)
    '("j" . sp-backward-slurp-sexp)
    '("s" . sp-raise-sexp)
    '("n" . sp-absorb-sexp)
    '("," . sp-split-sexp)
    '("e" . sp-end-of-sexp)
    '("a" . sp-beginning-of-sexp)
    '("G" . sp-goto-top)
    '("y" . sp-transpose-sexp)
    '("Y" . nt-back-transpose)
    '("l" . meow-undo))

  (setq meow-keypad-start-keys
        '((?c . ?c)
          (?x . ?x)
          (?o . ?h)))

  (meow-leader-define-key
   '("a" . "M-x")
   '("e" . "C-x b")
   '("u" . "C-x C-f")

   '("h" . "C-x o")
   '("t" . "C-x 0")
   '("T" . "C-x 1")
   '("s" . "C-x C-k")
   '("S" . "C-x k")
   '("n" . "C-x 3")
   '("N" . "C-x 2")

   '("1" . meow-digit-argument)
   '("2" . meow-digit-argument)
   '("3" . meow-digit-argument)
   '("4" . meow-digit-argument)
   '("5" . meow-digit-argument)
   '("6" . meow-digit-argument)
   '("7" . meow-digit-argument)
   '("8" . meow-digit-argument)
   '("9" . meow-digit-argument)
   '("0" . meow-digit-argument)
   '("/" . meow-keypad-describe-key)
   '("?" . meow-cheatsheet)

   '("w" . save-buffer)
   '("C" . open-init-file))

  (setq latex-thing-regexp
        '(regexp "\\\\begin{.*?}\\(.*?\\)\n\\|\\$"
                 "\\\\end{.*?}\n\\|\\$"))

  (meow-thing-register 'latex
                       latex-thing-regexp
                       latex-thing-regexp)

  (add-to-list 'meow-char-thing-table
               (cons ?x 'latex))

  (setq meow-use-clipboard t)

  (defun meow-clipboard-toggle ()
    (interactive)
    (if meow-use-clipboard
        (progn
          (setq meow-use-clipboard nil)
          (message "Meow clipboard usage disabled"))
      (progn
        (setq meow-use-clipboard t)
        (message "Meow clipboard usage enabled"))))

  (meow-leader-define-key '("l" . meow-clipboard-toggle))

  (setq meow-expand-exclude-mode-list '())

  (setq avy-keys '(?n ?r ?t ?s ?g ?p ?h ?a ?e ?i))

  (setq meow-command-to-short-name-list
        (append meow-command-to-short-name-list
                '((nt-add-number . "+num")
                  (nt-bounds-str . "[str]")
                  (nt-inner-str . "←str→")
                  (nt-insert-at-cursor . "ins.")
                  (nt-negative-find . "←find")
                  (nt-negative-till . "←till")
                  (nt-paragraph . "[para]")
                  (nt-subtract-one . "-1")
                  (nt-toggle-case-dwiam . "case"))))

  ;;;###autoload
  (defun turn-on-meow ()
    (interactive)
    (meow-global-mode 1)
    (which-key-mode 1)
    (unless (display-graphic-p)
      (setq meow-esc-delay 0)))

  ;;;###autoload
  (defun turn-off-meow ()
    (interactive)
    (which-key-mode -1)
    (meow-global-mode -1))

  (provide 'meow-custom)
  ;;; meow-custom.el ends here
#+END_SRC

** Enable
#+BEGIN_SRC emacs-lisp
  (turn-on-meow)
#+END_SRC

* Other
** Dashboard
#+BEGIN_SRC emacs-lisp
  (require 'dashboard)
  (dashboard-setup-startup-hook)
#+END_SRC

** Wakatime
#+BEGIN_SRC emacs-lisp
  (require 'wakatime-mode)
  (global-wakatime-mode)
#+END_SRC

** Claude Code
#+BEGIN_SRC emacs-lisp
  (require 'claudemacs)
  (require 'eat)
  ;; (define-key prog-mode-map (kbd "C-c C-e") #'claudemacs-transient-menu)
  ;; (define-key emacs-lisp-mode-map (kbd "C-c C-e") #'claudemacs-transient-menu)
  ;; (define-key text-mode-map (kbd "C-c C-e") #'claudemacs-transient-menu)
  ;; (define-key python-base-mode-map (kbd "C-c C-e") #'claudemacs-transient-menu)
  (meow-leader-define-key
   '("." . claudemacs-transient-menu))


  ;; Set a big buffer so we can search our history.
  (with-eval-after-load 'eat
    (setq eat-term-scrollback-size 400000))

  ;; If you want it to pop up as a new buffer. Otherwise, it will use "other buffer."
  ;; Personally, I use the default "other buffer" style.
  (add-to-list 'display-buffer-alist
               '("^\\*claudemacs"
                 (display-buffer-in-side-window)
                 (side . right)
                 (window-width . 0.33)))

  ;; Turn on autorevert because Claude modifies and saves buffers. Make it a habit to save
  ;; before asking Claude anything, because it uses the file on disk as its source of truth.
  ;; (And you don't want to lose edits after it modifies and saves the files.)
  (global-auto-revert-mode t)
#+END_SRC

** Perspective
#+BEGIN_SRC emacs-lisp
  (require 'perspective)
  (global-set-key (kbd "C-x C-b") 'persp-ibuffer)
  (customize-set-variable 'persp-mode-prefix-key (kbd "C-c M-p"))
  (meow-leader-define-key
   '("b" . "C-x C-b")
   '("p" . "C-c M-p"))
  (customize-set-variable 'persp-state-default-file "~/.emacs.perspective")
  (add-hook 'kill-emacs-hook #'persp-state-save)
  (persp-mode)
#+END_SRC

* Language specific
** Eglot
#+BEGIN_SRC emacs-lisp
  (require 'eglot)
#+END_SRC
** Nix
#+BEGIN_SRC emacs-lisp
  (require 'nix-ts-mode)
  (add-to-list 'auto-mode-alist '("\\.nix\\'" . nix-ts-mode))

  (with-eval-after-load 'eglot
    ;; Prefer nixd to nil, and enable in nix-ts-mode too
    (add-to-list 'eglot-server-programs
                 `(nix-ts-mode . ,(eglot-alternatives '("nixd" "nil")))))

  (require 'nixpkgs-fmt)
  (require 'nixfmt)
#+END_SRC

** Kanata
#+BEGIN_SRC emacs-lisp
  (require 'kanata-kbd-mode)
  (add-to-list 'auto-mode-alist '("\\.kbd\\'" . kanata-kbd-mode))  
#+END_SRC

** Rust
#+BEGIN_SRC emacs-lisp
  (require 'rust-mode)
  (require 'flycheck-rust)
  (with-eval-after-load 'rust-mode
    (add-hook 'flycheck-mode-hook #'flycheck-rust-setup))
#+END_SRC

* Keybindings

#+BEGIN_SRC emacs-lisp
  ; buffer-menu -> ibuffer
  ; (global-set-key (kbd "C-x C-b") 'ibuffer)
  (meow-leader-define-key
   '("q" . "C-x C-c"))

#+END_SRC
